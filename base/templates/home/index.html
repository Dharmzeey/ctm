{% extends 'base/base.html' %}

{% block title %}
<title>Campus Trade Mart</title>
{% endblock %}

{% block content %}

<div>
  <form class="py-3 border-none" action="{% url 'search' %}">
    <label class="py-3" for="q">
      <input type="text" name="q" id="q" placeholder="Search Products">
    </label>
  </form>
</div>
<div>
  <form class="flex flex-col gap-2" id="data-form" data-url="{% url 'load_data' %}">
    <div>Current Viewing State: <small><b>{{ request.session.viewing_state|default:"Not Set" }}</b></small>
      {{ form.state }}
      <!-- {% if request.session.viewing_state %} <span>Change</span> {% else %} <span>Set</span> {% endif %} -->
    </div>
    <div>Current Viewing Location: <small><b>{{ request.session.viewing_location|default:"Not Set" }}</b></small>
      {{ form.location }}
      <!-- {% if request.session.viewing_location %} <span>Change</span> {% else %} <span>Set</span> {% endif %} -->
    </div>
    <div>Current Viewing Institution: <small><b>{{ request.session.viewing_institution|default:"Not Set" }}</b></small>
      {{ form.institution }}
      <!-- {% if request.session.viewing_institution %} <span>Change</span> {% else %} <span>Set</span> {% endif %} -->
    </div>
    <div>
      {% if request.user.is_authenticated %}
      <button id="reset" type="reset">Reset</button>
      {% endif %}
      <button id="general" type="reset">Set to General</button>
    </div>
  </form>
</div>

<div id="recent-and-products">
  {% if products or recent %}
  {% if products %}
  <section id="product">
    <h1 class="font-bold py-4 text-xl">Products</h1>
    <div class="grid-items">
      {% for good in products %}
      <div class="w-full h-full bg-white">
        <a class="flex flex-col justify-between" href="{% url 'store:detail_product' store_name=good.store.store_name product_uuid=good.uuid  %}">
          <div class="img-wrapper">
            <img class="rounded-t-md" src="{{ good.thumbnail.url }}" alt="{{ good.title }}">
          </div>
          <div class="px-4">
            <div class="pt-4">{{ good.title }}</div>
            <div>
              <small>&#8358; {{ good.price }}</small>
            </div>
          </div>
        </a>
        <small class="m-4 mb-6">
          <a class="link" href="{% url 'store:detail_store' store_name=good.store.store_name %}">{{ good.store.store_name }}</a>
        </small>
      </div>
      {% endfor %}
    </div>
  </section>
  {% endif %}

  {% if recent %}
  <section id="recent">
    <h1 class="font-bold py-4 text-xl">Recent</h1>
    <div class="grid-items">
      {% for good in recent %}
      <div class="w-full h-full bg-white">
        <a class="flex flex-col justify-between" href="{% url 'store:detail_product' store_name=good.store.store_name product_uuid=good.uuid  %}">
          <div class="img-wrapper">
            <img class="rounded-t-md" src="{{ good.thumbnail.url }}" alt="{{ good.title }}">
          </div>
          <div class="px-4">
            <div class="pt-4">{{ good.title }}</div>
            <div>
              <small>&#8358; {{ good.price }}</small>
            </div>
          </div>
        </a>
        <small class="m-4 mb-6">
          <a class="link" href="{% url 'store:detail_store' store_name=good.store.store_name %}">{{ good.store.store_name }}</a>
        </small>
      </div>
      {% endfor %}
    </div>
  </section>
  {% endif %}

  {% elif not products and not recent %}
  <h1>No Items to show</h1>
  {% endif %}

</div>

{% endblock %}


{% block script %}
<script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
<script>

  $('#id_state').change(function () {
    let url = $("#data-form").attr("data-url");
    let state = $(this).val();
    $.ajax({
      url: url,
      data: {
        'state': state
      },
      success: function (data) {
        $("#id_location").html(data);
        $("#id_institution").html('<option value="">---------</option>');

        let productUrl = "{% url 'filter_load' %}"
        $.ajax({
          url: productUrl,
          success: function (data) {
            $("#recent-and-products").html(data)
          }
        })
      }
    })
  })

  $("#id_location").change(function () {
    let url = $("#data-form").attr("data-url");
    let location = $(this).val();
    $.ajax({
      url: url,
      data: {
        'location': location
      }, success: function (data) {
        $("#id_institution").html(data)

        let productUrl = "{% url 'filter_load' %}"
        $.ajax({
          url: productUrl,
          success: function (data) {
            $("#recent-and-products").html(data)
          }
        })
      }
    })
  })


  $("#id_institution").change(function () {
    let storeUrl = $("#data-form").attr("data-url");
    let institution = $(this).val();
    $.ajax({
      url: storeUrl,
      data: {
        'institution': institution
      },
      success: function (data) {
        $("#store-list").html(data);

        let productUrl = "{% url 'filter_load' %}"
        $.ajax({
          url: productUrl,
          success: function (data) {
            $("#recent-and-products").html(data)
          }
        })
      }
    })
  })

  $("#reset").click(function () {
    let buttonUrl = "{% url 'reset_general' %}"
    $.ajax({
      url: buttonUrl,
      data: {
        'reset': true
      }, success() {
        location.reload()
      }
    })
  })

  $("#general").click(function () {
    let buttonUrl = "{% url 'reset_general' %}"
    $.ajax({
      url: buttonUrl,
      data: {
        'general': true
      }, success() {
        location.reload()
      }
    })
  })

</script>

{% endblock %}